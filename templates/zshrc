#login shell
# /usr/local/Cellar/zsh/5.0.2/bin/zsh-5.0.2 -i
# don't use anything below this version!
platform='unknown'
unamestr=`uname`
if [[ "$unamestr" == 'Linux' ]]; then
   platform='linux'
elif [[ "$unamestr" == 'Darwin' ]]; then
   platform='osx'
fi

#zshell
ZSH=$HOME/.oh-my-zsh
ZSH_THEME="robbyrussell"
#plugins=(bundler rake rake-fast cp gem lein git vi-mode sudo ruby brew)
source $ZSH/oh-my-zsh.sh

export PATH=$PATH:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/git/bin:/Library/PostgreSQL/9.3/bin:/Users/apetrov/node_modules/coffee-script/bin
export SBT_OPTS="-Xmx2048M -XX:MaxPermSize=256M" #Scala build too
export EDITOR='vim'
bindkey -v # VIM binding for zsh

#SSH certificates
ssh-add ~/.ssh/id_rsa >/dev/null  2>&1
ssh-add ~/.ssh/apetrov_virool_rsa >/dev/null  2>&1

#RVM
PATH=$PATH:$HOME/.rvm/bin # Add RVM to PATH for scripting
[[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm" # Load RVM into a shell session *as a function*

#Redefine standard tools on osx
if [[ $platform == 'osx' ]]; then
  PATH="/usr/local/opt/coreutils/libexec/gnubin:$PATH"
  MANPATH="/usr/local/opt/coreutils/libexec/gnuman:$MANPATH"
  alias ctags="`brew --prefix`/bin/ctags"
  alias vim="/Applications/MacVim.app/Contents/MacOS/Vim"
  # https://gist.github.com/quickshiftin/9130153
  alias man='_() { echo $1; man -M $(brew --prefix)/opt/coreutils/libexec/gnuman $1 1>/dev/null 2>&1;  if [ "$?" -eq 0 ]; then man -M $(brew --prefix)/opt/coreutils/libexec/gnuman $1; else man $1; fi }; _'
fi

function remote-db(){
  rm -f config/database.yml;
  ln -s $(pwd)/config/database.remote.yml config/database.yml;
  echo "in remote mode";
}

function local-db(){
  rm -f config/database.yml;
  ln -s $(pwd)/config/database.local.yml config/database.yml;
  echo "in local mode"
}

function share(){
  curl --upload-file ./$1 https://transfer.sh/$1 | pbcopy;
  echo `pbpaste`;
}

# Convinience tools
alias hh='pbpaste | html2haml | pbcopy'
alias ss='python -m SimpleHTTPServer'
alias -g jsonformat='python -m json.tool'
alias -g xmlformat="xmllint -format"
alias -g be='bundle exec'
alias -s log="tail -f"
alias virool-deploy="bundle exec rake assets:precompile && be cap deploy:assets:update_manifest && be cap deploy"
alias spotlight-stop="sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist"
alias spotlight-start="sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist"
alias git='/usr/local/Cellar/git/2.1.2/bin/git'
alias up='git pull'
alias pull='git pull'
alias -g push='git push'
alias -g commit='git commit -m'
alias deploy='bundle exec cap production deploy'

function psql2 {
  psql -U `cat ~/.pgpass | grep $1 | cut -d: -f4` -h `cat ~/.pgpass | grep $1 | cut -d: -f1` $2
}
__rvm_project_rvmrc  #https://rvm.io/integration/zsh/

function prune(){
  git branch --merged | grep -v "\*" | xargs -n 1 git branch -d
  git fetch -p
  git gc
}

function whiteboard(){
  convert $1 -morphology Convolve DoG:15,100,0 -negate -normalize -blur 0x1 -channel RBG -level 60%,91%,0.1 $2
}

# promt patch
# http://superuser.com/questions/151803/how-do-i-customize-zshs-vim-mode
function zle-line-init zle-keymap-select {
    RPS1="${${KEYMAP/vicmd/-- NORMAL --}/(main|viins)/-- INSERT --}"
    RPS2=$RPS1
    zle reset-prompt
}
zle -N zle-line-init
zle -N zle-keymap-select


function psql3(){
  psql -U `cat ~/.pgpass | grep $PSQL_SERVER | cut -d: -f4` -h `cat ~/.pgpass | grep $PSQL_SERVER | cut -d: -f1` $PSQL_DB
}

function connect(){
  export PSQL_SERVER=$1
  export PSQL_DB=$2
}

function pcsv(){
  echo "copy($1) to STDOUT with csv;" | psql3
}

function phcsv(){
  echo "copy($1) to STDOUT with csv header;" | psql3
}

function to(){
  ssh virool@$1.virool
}
